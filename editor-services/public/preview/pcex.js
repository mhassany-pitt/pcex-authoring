const translations = {
	en: {
		'title-example-prefix': 'Example: ',
		'title-challenge-prefix': 'Challenge: ',
		'next-btn-example': 'Next Example',
		'next-btn-challenge': 'Challenge Me!',
		'decrease-indentation-btn': 'Decrease Indentation',
		'increase-indentation-btn': 'Increase Indentation',
		'check-result-correct': 'Correct!',
		'user-input': 'User Input',
		'output': 'Output',
		'incorrect-try-again': 'Incorrect. Try Again!',
		'your-program-throws-exception': 'Your program throws exception',
		'exception-details': 'Exception Details',
		'your-program-has-compilation-error': 'Your program has compilation error',
		'compilation-error-details': 'Compilation Error',
		'your-program-output-is-different': 'Your program output is different than the expected output',
		'program-output-details': 'Program Output Details',
		'is-incorrect': 'is incorrect',
		'are-incorrect': 'are incorrect',
		'has-indentation-error': 'has indentation error',
		'have-indentation-error': 'have indentation error',
		'fill-in-your-code-here': 'FILL IN YOUR CODE HERE',
		'drag-a-tile-to-construct': 'Drag a tile to each missing field to construct this program.',
		'previous': 'Previous',
		'additional-details': 'Additional details',
		'increase-indentation-by': 'Increase indentation in line lineNumber by levelDifference', // don't translate 'lineNumber' and 'levelDifference' -- they are placeholders
		'decrease-indentation-by': 'Decrease indentation in line lineNumber by levelDifference', // don't translate 'lineNumber' and 'levelDifference' -- they are placeholders
		'program-construction-examples': 'Program Construction Examples',
		'back-btn': 'Back',
		'explain-the-program': 'Explain the program',
		'clear': 'Clear',
		'next-challenge': 'Next Challenge',
		'show-me-correct-program': 'Show Me Correct Program',
		'show-me-hint': 'Explain',
		'tell-me-whats-wrong': 'Tell me what’s wrong',
		'explanations': 'Explanations',
		'next': 'Next',
		'hint': 'Hint',
		'drag-tile-from-here': 'Drag a tile from here',
		'check': 'CHECK',
		'current-output': 'Current Output',
		'expected-output': 'Expected Output',
		'close': 'Close',
		'provide-feedback': 'provide feedback on this explanation (optional)',
		'helpful-explanation-instruction': 'Please rate this explanation on a 1–5 scale (1=low, 5=high):',
		'it-clearly-explained-why-this-option-is-wrong': 'It clearly explained why this option is wrong.',
		'it-clarified-a-misconception-i-didnt-realize-i-had': 'It clarified a misconception I didn’t realize I had.',
		'here-is-what-i-would-add-change-in-this-explanation': 'What could make this explanation more helpful (optional)?',
		'it-is-clear-and-easy-to-understand': 'It is clear and easy to understand.',
		'it-helped-me-understand-the-purpose-of-the-line': 'It helped me understand the purpose of the line.',
		'submit-feedback': 'Submit Feedback',
		'feedback-submitted-successfully': 'Feedback submitted successfully. Thank you for your feedback!',
		'feedback-submission-error': 'An error occurred while submitting feedback. Please try again later.',
	},
	es: {
		'title-example-prefix': 'Ejemplo: ',
		'title-challenge-prefix': 'Desafío: ',
		'next-btn-example': 'Siguiente ejemplo',
		'next-btn-challenge': '¡Desafíame!',
		'decrease-indentation-btn': 'Disminuye la indentación',
		'increase-indentation-btn': 'Aumenta la indentación',
		'check-result-correct': '¡Correcto!',
		'user-input': 'Entrada del usuario',
		'output': 'Salida',
		'incorrect-try-again': 'Incorrecto, intenta de nuevo',
		'your-program-throws-exception': 'Tu programa arroja una excepción',
		'exception-details': 'Detalles de la excepción',
		'your-program-has-compilation-error': 'Tu programa tiene un error de compilación',
		'compilation-error-details': 'Error de compilación',
		'your-program-output-is-different': 'La salida de tu programa es distinta que la esperada',
		'program-output-details': 'Detalles de la salida del programa',
		'is-incorrect': 'es incorrecto(a)',
		'are-incorrect': 'son incorrectos(as)',
		'has-indentation-error': 'tiene error de indentación',
		'have-indentation-error': 'tienen error de indentación',
		'fill-in-your-code-here': 'COMPLETA TU CÓDIGO AQUÍ',
		'drag-a-tile-to-construct': 'Arrastra un bloque de código hacia una de los espacios faltantes para construir tu programa',
		'previous': 'Previo(a)',
		'additional-details': 'Detalles adicionales',
		'increase-indentation-by': 'Aumenta la indentación en la línea lineNumber en levelDifference nivel(es)', // don't translate 'lineNumber' and 'levelDifference' -- they are placeholders
		'decrease-indentation-by': 'Disminuye la indentación en la línea lineNumber en levelDifference nivel(es)', // don't translate 'lineNumber' and 'levelDifference' -- they are placeholders
		'program-construction-examples': 'Ejemplos de Construcción de Programas',
		'back-btn': 'Volver',
		'explain-the-program': 'Explica el programa',
		'clear': 'Restablecer',
		'next-challenge': 'Siguiente desafío',
		'show-me-correct-program': 'Muéstrame el programa correcto',
		'show-me-hint': 'Explica',
		'tell-me-whats-wrong': 'Dime qué está mal',
		'explanations': 'Explicaciones',
		'next': 'Siguiente',
		'hint': 'Pista',
		'drag-tile-from-here': 'Arrastra un bloque de código desde aquí',
		'check': 'COMPROBAR',
		'current-output': 'Salida actual',
		'expected-output': 'Salida esperada',
		'close': 'Cerrar',
		'provide-feedback': 'da tu opinión sobre esta explicación (opcional)',
		'helpful-explanation-instruction': 'Por favor califique esta explicación en una escala del 1 al 5 (1 = bajo, 5 = alto):',
		'it-clearly-explained-why-this-option-is-wrong': 'Explicó claramente por qué esta opción es incorrecta.',
		'it-clarified-a-misconception-i-didnt-realize-i-had': 'Aclaró una idea errónea que no me había dado cuenta de que tenía.',
		'here-is-what-i-would-add-change-in-this-explanation': '¿Qué podría hacer que esta explicación fuera más útil (opcional)?',
		'it-is-clear-and-easy-to-understand': 'Está claro y es fácil de entender.',
		'it-helped-me-understand-the-purpose-of-the-line': 'Me ayudó a entender el propósito de la línea.',
		'submit-feedback': 'Enviar comentarios',
		'feedback-submitted-successfully': 'Comentarios enviados con éxito. ¡Gracias por tus comentarios!',
		'feedback-submission-error': 'Ocurrió un error al enviar los comentarios. Por favor, inténtalo de nuevo más tarde.',
	}
};

const _text = (key) => translations[url('?locale') || 'en']?.[key] || key;

// remove single quote, double quote, and comma
const cleanName = (name) => name?.replace(/['",]/g, '');

const isWeatPCEX = (name) => name.replace(/__([a-f0-9]{24})-([a-f0-9]{24})_(example|challenge)-([0-9]{1,2})$/, '').replace(/__([a-f0-9]{24})-([a-f0-9]{24})-([0-9]{1,2})$/, '') != name;

$(document).ready(function () {
	// translate all elements with translate-key attribute
	$('[translate-key]').each(function () {
		$(this).text(_text($(this).attr('translate-key')));
	});

	$('#back-button > span').text(_text('back-btn'));
	$('#next-button > span').text(_text('next-btn-challenge'));
	$('#start-animation-button > span').text(_text('explain-the-program'));
	$('#clear-button').text(_text('clear'));
	$('#shortcut-next-button').text(_text('next-challenge'));
	$('#show-correct-button').text(_text('show-me-correct-program'));
	$('#show-hint-button').text(_text('show-me-hint'));
	$('#show-message-details').text(_text('tell-me-whats-wrong'));
	// -----------
	$('#check-button').click(pcex.check);
	$('#start-animation-button').click(pcex.startAnimationClick);
	$('#stop-animation-button').click(pcex.stopAnimationClick);
	$('#animation-next-button').click(pcex.animationNext);
	$('#animation-back-button').click(pcex.animationBack);
	$(document).on('click', '#line-explanation-provide-feedback-btn', pcex.handleLineExplanationFeedbackToggle);
	$(document).on('click', '#line-explanation-feedback-ui button[type=button]', pcex.handleLineExplanationFeedbackSubmit);
	$(document).on('click', '#distractor-explanation-provide-feedback-btn', pcex.handleDistractorExplanationFeedbackToggle);
	$(document).on('click', '#distractor-explanation-feedback-ui button[type=button]', pcex.handleDistractorExplanationFeedbackSubmit);

	$('#clear-button').click(pcex.clearIncorrectAnswer);

	$('#overlay').click(pcex.overlayFadeOut);

	$('#back-button').attr('disabled', true);
	$('#back-button').click(pcex.back);

	$('#next-button').click(pcex.next);
	$('#next-button').attr('disabled', false);

	$('#shortcut-next-button').click(pcex.next);
	$('#show-correct-button').click(pcex.showMeCorrectSolution).hide();
	$('#show-hint-button').click(pcex.showHint).hide();
	$('#show-message-details').click(pcex.showResultMessageDetails).hide();

	$('#close-hint-button').click(function () {
		pcex.clearHint();
		pcex.clearAllWrongBlankLinesHighlight();
	});

	pcex.parse();

	$(window).scroll(function (eventObject) {
		if (!pcex.isScrollNeeded()) {
			return;
		}

		var divCodeBottomY = $('#div_code').position().top + $('#div_code').height();
		var scrollTop = $(window).scrollTop();

		var currentTop = $('#scrollable').css('top').replace("px", "");

		if (scrollTop <= divCodeBottomY) {
			if ($('#checkCollapsible').is(":hidden") || currentTop > scrollTop) {
				if ($('#tiles').is(':visible') && pcex.animationStarted == false) {
					var lastBlankLinePosition = $('#' + pcex.blankLineIDs[pcex.blankLineIDs.length - 1]).position().top;
					var newDivTilesBottomY = scrollTop + $('#drag-tile-div').height() / 2;

					if (newDivTilesBottomY <= lastBlankLinePosition) {
						$('#scrollable').css('top', scrollTop);
					} else {
						var position = lastBlankLinePosition - $('#drag-tile-div').height() / 2;
						if (position >= 0) {
							$('#scrollable').css('top', position);
						} else {
							$('#scrollable').css('top', 0);
						}
					}
				}
			}
		}
	});

	$('.modal').modal({
		dismissible: true, // Modal can be dismissed by clicking outside of the modal
		inDuration: 300, // Transition in duration
		outDuration: 200, // Transition out duration
		startingTop: '4%', // Starting top style attribute
		endingTop: '10%', // Ending top style attribute
		ready: function (modal, trigger) { // Callback for Modal open. Modal and trigger parameters available.

		}
		/*complete: function() { alert('Closed'); } // Callback for Modal close*/
	});

	$('.container-fluid').show();
});

var pcex = {
	//For Reporting
	userCredentials: null,
	activityType: null,
	umApplicationId: null,
	pcexTrackingID: null,

	jsonData: null,
	scrollLineLimit: 20,
	numberOfTrialsForHint: 1,
	maxNumberOfTrials: 3,
	activityIndex: 0,
	numberOfGoals: 0,
	isPython: false,
	indentChar: null,
	codeHighlightClass: null,
	commentString: null,
	indentPopoverShown: false,
	goalSolvedStates: null,
	goalShowResultStates: null,
	lastChallengeState: null,

	currentGoal: null,
	currentGoalIndex: 0,

	animationStarted: false,
	animationStepIndex: 0,
	numberOfTrials: 0,
	lineList: null,
	blankLines: [],
	blankLineIDs: [],
	blankLineNumbers: [],
	tiles: [],
	linesWithExplanation: [],
	droppedTiles: null,
	hiddenTiles: null,
	correctBlankLineIDs: [],
	indentedIncorrectBlanLineIDs: [],
	droppedTileIndentation: null,

	resizeIframe: function () {
		parent.postMessage({
			messageType: "resize",
			iframeHeight: document.body.scrollHeight + 24,
			iframeUrl: window.location.href
		}, "*");

		parent.postMessage({
			subject: "lti.frameResize",
			message_id: Math.random().toString(36).substring(2),
			height: document.body.scrollHeight + 24,
			width: document.body.scrollWidth + 24,
		}, "*");
	},

	parse: function (language, setName) {
		var usr = url('?usr');
		var grp = url('?grp');
		var sid = url('?sid');
		// var language = url('?lang');
		// var setName = url('?set');
		var svc = url('?svc') ? url('?svc') : 'masterygrids';  //SVC is an optional parameter
		const load = url('?load');

		var index = 0; // default goal index is 0
		if (url('?index')) {
			index = parseInt(url('?index'));
			$('#back-button').attr('disabled', true).hide();
			$('#next-button').attr('disabled', true).hide();
		}

		if (load) $.ajax({
			url: load,
			dataType: 'json',
			xhrFields: { withCredentials: true },
			success: function (data) {
				pcex.jsonData = data[0];
				pcex.currentGoalIndex = index;

				pcex.numberOfGoals = pcex.jsonData.activityGoals.length;
				pcex.goalSolvedStates = new Array(pcex.numberOfGoals);
				pcex.goalShowResultStates = new Array(pcex.numberOfGoals);
				pcex.setLanguageSettings(pcex.jsonData.language);
				pcex.setUserCredentials(usr, grp, sid, svc);
				pcex.init();
			}
		});
	},

	setUserCredentials: function (usr, grp, sid, svc) {
		if (usr && grp && sid) {
			pcex.userCredentials = {
				user: usr,
				group: grp,
				sessionId: sid,
				svc: svc
			};
		}
	},

	setLanguageSettings: function (language) {
		pcex.isPython = language === 'PYTHON';
		if (pcex.isPython) {
			pcex.indentChar = '    ';
			pcex.commentString = '#';
			pcex.codeHighlightClass = 'python hljs';
		} else {
			pcex.indentChar = '  ';
			pcex.commentString = '//';
			pcex.codeHighlightClass = 'java hljs';
		}
	},

	init: function () {
		pcex.currentGoal = pcex.jsonData.activityGoals[pcex.currentGoalIndex];
		pcex.isInLastGoal = pcex.currentGoalIndex == pcex.numberOfGoals - 1;

		if (pcex.currentGoalIndex == 0) {
			$('#back-button').attr('disabled', true).hide();
		}
		if (pcex.isInLastGoal) {
			$('#shortcut-next-button').attr('disabled', true).hide();
			$('#next-button').hide();
		}

		var pre = document.createElement('pre');
		var code = document.createElement('code');
		code.setAttribute("class", pcex.codeHighlightClass);

		pcex.lineList = pcex.currentGoal.lineList;

		$.each(pcex.currentGoal.lineList, function (i, line) {
			var lineContent = pcex.createLineContent(line, false, false);
			$(code).append(lineContent);

			if (line.commentList.length > 0) {
				pcex.linesWithExplanation.push(line);
			}
		});

		$(pre).append(code);
		$('#div_code').append(pre);
		hljs.highlightBlock(code);
		pcex.fixBrokenHelpIcons();

		pcex.currentGoal.goalDescription = pcex.currentGoal.goalDescription.replace(/\\n/g, '<br>');

		// remove the unique-id from end of goal name
		// this unique-id is used to make sure goal name is globally unique
		let goalName = pcex.currentGoal.name
			.replace(/__([a-f0-9]{24})-([a-f0-9]{24})_(example|challenge)-([0-9]{1,2})$/, '')
			.replace(/__([a-f0-9]{24})-([a-f0-9]{24})-([0-9]{1,2})$/, '');
		if (pcex.currentGoal.fullyWorkedOut) {
			pcex.activityType = 'ex';
			pcex.umApplicationId = 46;
			pcex.changeStyleToFullyWorkedOut();
			$('#goal_title').html("<img src='img/reader-24_white.png' />" + _text('title-example-prefix') + goalName);
		} else {
			pcex.activityType = 'ch';
			pcex.umApplicationId = 47;
			$('#goal_title').html("<img src='img/examination-24_white.png' />" + _text('title-challenge-prefix') + goalName);

			$.each(pcex.currentGoal.blankLineList, function (i, blankLine) {
				pcex.blankLines.push(blankLine);
				pcex.blankLineIDs.push("line_" + blankLine.line.id);
				pcex.blankLineNumbers.push(blankLine.line.number);
			});

			pcex.highlightGoalTitle();

			if (pcex.goalSolvedStates[pcex.currentGoalIndex]) { //Need to show like a fully worked-out example
				pcex.loadGoalState();
				pcex.changeStyleToChallenge();
				pcex.showCorrect();

				if (pcex.goalShowResultStates[pcex.currentGoalIndex]) { //Correct answer is shown by Show me correct answer
					pcex.activityType = 'ch_not_solved';
				} else {
					pcex.activityType = 'ch_solved';
				}
			} else {
				pcex.changeStyleToChallenge();
				pcex.droppedTiles = new Array(pcex.currentGoal.blankLineList.length);
				pcex.hiddenTiles = new Array(pcex.currentGoal.blankLineList.length);
				pcex.droppedTileIndentation = new Array(pcex.currentGoal.blankLineList.length).fill(0);

				$.each(pcex.currentGoal.blankLineList, function (i, blankLine) {
					pcex.convertRegularCodeLineToBlankLine(blankLine.line.id);

					var tileCodeContent = pcex.createTileContent(blankLine);
					pcex.tiles.push(tileCodeContent);
				});

				$.each(pcex.currentGoal.distractorList, function (i, distractor) {
					var tileCodeContent = pcex.createTileContent(distractor);
					pcex.tiles.push(tileCodeContent);
				});

				pcex.tiles = pcex.shuffleArray(pcex.tiles);
				$.each(pcex.tiles, function (i, tile) {
					$('#tiles').append(tile);
				});

				pcex.loadGoalState();
			}
		}

		pcex.updateNextButtonText();

		$("a[id^='help_']").unbind('click').click(pcex.handleHelpButtonClicked);
		pcex.trackUserActivity();

		pcex.resizeIframe();
	},

	updateNextButtonText: function () {
		const nextGoalIndex = pcex.currentGoalIndex + 1;
		if (nextGoalIndex < pcex.numberOfGoals) {
			const nextGoal = pcex.jsonData.activityGoals[nextGoalIndex];
			$('#next-button span').text(nextGoal.fullyWorkedOut ? _text('next-btn-example') : _text('next-btn-challenge'));
		}
	},

	convertRegularCodeLineToBlankLine: function (lineId) {
		$("#line_" + lineId).html("\n").addClass("code-blank-line ui-state-default").droppable({
			accept: '.tile-dragging-start, .tile-dragged, .code-blank-line-error',
			hoverClass: 'hovered',
			tolerance: "pointer",
			drop: function (event, ui) {
				pcex.handleTileDrop(this, ui.draggable);
			}
		});
	},

	createLineContent: function (line, includeIndentButtons, isTileDrop, blankLineIndex) {
		var lineContent = document.createElement('div');
		var indentedCode = pcex.getIndentedCode(line, isTileDrop, blankLineIndex);
		$(lineContent).attr("id", "line_" + line.id).addClass('line');
		if (indentedCode.trim().startsWith(pcex.commentString)) { //Highlight step lines
			$(lineContent).addClass('stepline');
		}

		const lineNumber = isTileDrop
			? String("  " + pcex.blankLineNumbers[blankLineIndex]).slice(-2)
			: String("  " + line.number).slice(-2);
		var lineNumberSpan = document.createElement('span');
		// To have a fixed length line number, which is 2 in all cases.
		$(lineNumberSpan).addClass('linenumber').html(lineNumber);
		$(lineContent).prepend(lineNumberSpan);

		var helpButton = null;
		if (includeIndentButtons || line.commentList.length > 0) {
			lineContent.appendChild(document.createTextNode(indentedCode));

			if (line.commentList.length > 0) {
				helpButton = document.createElement('a');
				$(helpButton).addClass('btn-floating btn-small waves-effect waves-light red').attr('id', 'help_' + line.id);

				var helpIcon = document.createElement('i');
				helpIcon.setAttribute("class", 'material-icons');
				helpIcon.innerHTML = 'help';

				$(helpIcon).click(function () {
					console.log('icon clicked');
				});

				helpButton.appendChild(helpIcon);
				lineContent.prepend(helpButton);

				if (pcex.currentGoal.fullyWorkedOut == false) {
					$(helpButton).hide();
					lineNumberSpan.style.marginLeft = '21px';
				} else {
					lineNumberSpan.style.marginLeft = '5px';
				}
			}

			if (includeIndentButtons) {
				var decreaseIndentButton = pcex.createIndentButton(false, blankLineIndex);
				lineContent.prepend(decreaseIndentButton);
				$(decreaseIndentButton).attr('disabled', true);

				var increaseIndentButton = pcex.createIndentButton(true, blankLineIndex);
				lineContent.appendChild(increaseIndentButton);

				if (!pcex.indentPopoverShown) {
					$(decreaseIndentButton).css('z-index', '99999');
					$(increaseIndentButton).css('z-index', '99999');
					$('#overlay').fadeIn(300);
				}

				lineNumberSpan.style.marginLeft = '21px';
			}
		} else {
			lineContent.append(indentedCode);
			if (!helpButton) lineNumberSpan.style.marginLeft = '21px';
		}

		// patch: post-comment line will be highlighted as comment as well
		lineContent.innerHTML += '\n';

		return lineContent;
	},

	getIndentedCode: function (line, isTileDrop, blankLineIndex) {
		if (isTileDrop) {
			if (pcex.isPython) {
				return line.content.trim();
			} else {
				var currentLineNumber = pcex.blankLineNumbers[blankLineIndex];
				var previousLineNumber = currentLineNumber - 1;
				var potentialCurrentIndentLevel = 0;
				var previousLineContent = "";

				for (i = previousLineNumber; i > 0; i--) { //loop over previous line numbers
					if (pcex.blankLineNumbers.includes(i)) { //If the line is a blank line
						var previousBlankLineIndex = pcex.blankLineNumbers.indexOf(i);

						if (pcex.droppedTiles[previousBlankLineIndex]) { //If a tile already dragged to that blank line, then we need to consider this blank line's indent level
							potentialCurrentIndentLevel = pcex.droppedTileIndentation[previousBlankLineIndex];
							previousLineNumber = i;
							previousLineContent = pcex.droppedTiles[previousBlankLineIndex].line.content.trim();
							break;
						}
					} else {
						potentialCurrentIndentLevel = pcex.lineList[i - 1].indentLevel;
						previousLineNumber = i;
						previousLineContent = pcex.lineList[i - 1].content.trim();
						break;
					}
				}

				var currentLineContent = pcex.droppedTiles[blankLineIndex].line.content.trim();

				if (previousLineContent.endsWith('{')) {
					potentialCurrentIndentLevel++;
				}

				if (currentLineContent.startsWith('}')) {
					potentialCurrentIndentLevel--;
				}

				pcex.droppedTileIndentation[blankLineIndex] = potentialCurrentIndentLevel;

				return pcex.indentChar.repeat(potentialCurrentIndentLevel) + line.content.trim();
			}
		} else {
			return pcex.indentChar.repeat(line.indentLevel) + line.content.trim();
		}

	},

	createIndentButton: function (increase, blankLineIndex) {
		var type = increase ? 'increase' : 'decrease';

		var indentButton = document.createElement('a');
		$(indentButton).attr('id', type + '-indent-button-' + blankLineIndex).addClass(type + '-indent-button btn-floating btn-small waves-effect waves-light blue sticky-popover');
		$(indentButton).attr('lineIndex', blankLineIndex);

		var indentIcon = document.createElement('i');
		$(indentIcon).attr("class", 'material-icons');
		$(indentIcon).html('format_indent_' + type);

		indentButton.appendChild(indentIcon);

		return indentButton;
	},

	createTileContent: function (tile) {
		var tileCodeContent = document.createElement('div');
		var tilePre = document.createElement('pre');
		$(tilePre).attr('id', 'tile_' + tile.id);
		var tileCode = document.createElement('code');

		$(tilePre).data('tile', tile).draggable({
			start: function () {
				$(this).addClass('tile-dragging-start');
				$(this).removeClass('tile-blank-line');
				$('.code-blank-line').filter(function () { return !$(this).hasClass('tile-dragged') }).addClass('ui-state-highlight');
			},
			drag: function () {

			},
			stop: function () {
				$(this).removeClass('tile-dragging-start');
				$(this).addClass('tile-blank-line');
				$('.code-blank-line').removeClass('ui-state-highlight');
			},
			containment: '#draggable',
			stack: '#tiles div',
			cursor: 'move',
			revert: true
		})


		$(tilePre).droppable({
			accept: '.tile-dragged, .code-blank-line-error',
			hoverClass: 'hovered-tile',
			drop: pcex.handleDraggedTileSwap,
			tolerance: "pointer"
		});

		$(tileCode).text(tile.line.content.trim())
		$(tilePre).addClass("tile-blank-line " + pcex.codeHighlightClass).append(tileCode);
		hljs.highlightBlock(tilePre);
		pcex.fixBrokenHelpIcons();
		return tilePre;
	},

	handleTileDrop: function (target, draggable) {
		var tile = $(draggable).data('tile');
		var blankLineId = $(target).attr('id');
		var blankLineIndex = $.inArray(blankLineId, pcex.blankLineIDs);

		var isDraggedItemAlreadyInAnotherBlankLine = $(draggable).hasClass('tile-dragged') || $(draggable).hasClass('code-blank-line-error');

		if (isDraggedItemAlreadyInAnotherBlankLine) { //Already dropped tile is dropped to another blank line
			$(draggable).removeClass().html("\n").addClass("code-blank-line ui-state-default").draggable('destroy');

			var clearedBlankLineIndex = $.inArray($(draggable).attr('id'), pcex.blankLineIDs);

			$(pcex.hiddenTiles[blankLineIndex]).show();
			pcex.hiddenTiles[blankLineIndex] = pcex.hiddenTiles[clearedBlankLineIndex];
			pcex.hiddenTiles[clearedBlankLineIndex] = undefined;

			pcex.droppedTiles[blankLineIndex] = pcex.droppedTiles[clearedBlankLineIndex];
			pcex.droppedTiles[clearedBlankLineIndex] = undefined;
		} else {
			pcex.droppedTiles[blankLineIndex] = tile;
			$(pcex.hiddenTiles[blankLineIndex]).show();
			pcex.hiddenTiles[blankLineIndex] = $(draggable);
			$(draggable).hide();
		}

		pcex.droppedTileIndentation[blankLineIndex] = 0;

		var lineContent = pcex.createLineContent(tile.line, pcex.isPython, true, blankLineIndex);
		$(lineContent).removeAttr('id').addClass(pcex.codeHighlightClass);

		if ($.trim($(target).html()).length == 0) { //droppable div empty
			$(target).empty().append(lineContent);
			$(target).addClass('tile-dragged');
		} else {
			$(target).empty().append(lineContent);
		}

		hljs.highlightBlock(lineContent);
		pcex.fixBrokenHelpIcons();

		pcex.makeFilledBlankLineDraggable($(target), tile);

		if (pcex.isPython == false && blankLineIndex != pcex.blankLineIDs.length - 1) { //If dropped tile is not dropped to the last blank line, modify indentation of previously dropped tiles
			for (var i = blankLineIndex + 1; i < pcex.blankLineIDs.length; i++) { //Need to check previous blank lines for indentation
				if (pcex.droppedTiles[i]) {
					var updatedBlankLineContent = pcex.createLineContent(pcex.droppedTiles[i].line, pcex.isPython, true, i);
					$(updatedBlankLineContent).removeAttr('id').addClass(pcex.codeHighlightClass);
					var lineElement = $('#' + pcex.blankLineIDs[i]).children(0)
					$(lineElement).replaceWith(updatedBlankLineContent);
					hljs.highlightBlock(updatedBlankLineContent);
					pcex.fixBrokenHelpIcons();
				}
			}
		}

		pcex.makeCheckButtonEnabledIfTilesFilled();

		if (pcex.isPython && !pcex.indentPopoverShown) {
			$('.decrease-indent-button').webuiPopover({ trigger: 'sticky', animation: 'pop', placement: 'bottom-right', content: _text('decrease-indentation-btn'), width: 140, onShow: function ($element) { $element.css('z-index', '99999') } });
			$('.increase-indent-button').webuiPopover({ trigger: 'sticky', animation: 'pop', placement: 'bottom-left', content: _text('increase-indentation-btn'), width: 140, onShow: function ($element) { $element.css('z-index', '99999') } });

			pcex.indentPopoverShown = true;
		}

		$('#increase-indent-button-' + blankLineIndex).click(pcex.handleIncreaseIndentButtonClicked);
		$('#decrease-indent-button-' + blankLineIndex).click(pcex.handleDecreaseIndentButtonClicked);

		pcex.hideCheckCollapsible();
		pcex.clearAllWrongBlankLinesHighlight();
		pcex.clearHint();
	},

	makeCheckButtonEnabledIfTilesFilled: function () {
		var blankLinesFilled = $('.code-blank-line').filter(function () { return $.trim($(this).html()).length == 0 }).length == 0;
		$('#check-button').attr("disabled", !blankLinesFilled);
	},

	handleIncreaseIndentButtonClicked: function () {
		var blankLineIndex = $(this).attr('lineIndex');
		pcex.handleIndentButtonClicked(blankLineIndex);

		const firstEl = $(this).closest('.line').find('.linenumber')[0].nextSibling;
		if (firstEl.nodeType === 3) { // a text node
			firstEl.nodeValue = '    ' + firstEl.nodeValue;
		} else if (firstEl.nodeType === 1) { // an element node
			firstEl.innerHTML = '    ' + firstEl.innerHTML;
		}

		pcex.droppedTileIndentation[blankLineIndex]++;

		$('#decrease-indent-button-' + blankLineIndex).attr('disabled', false);
	},

	handleDecreaseIndentButtonClicked: function () {
		var blankLineIndex = $(this).attr('lineIndex');
		pcex.handleIndentButtonClicked(blankLineIndex);

		const firstEl = $(this).closest('.line').find('.linenumber')[0].nextSibling;
		if (firstEl.nodeType === 3) { // a text node
			firstEl.nodeValue = firstEl.nodeValue.replace(/^\s{4}/, '');
		} else if (firstEl.nodeType === 1) { // an element node	
			firstEl.innerHTML = firstEl.innerHTML.replace(/^\s{4}/, '');
		}

		if (pcex.droppedTileIndentation[blankLineIndex] > 0) {
			pcex.droppedTileIndentation[blankLineIndex]--;

			if (pcex.droppedTileIndentation[blankLineIndex] == 0) {
				$(this).attr('disabled', true);
			}
		}
	},

	handleIndentButtonClicked: function (blankLineIndex) {
		pcex.overlayFadeOut();

		if (!$('#checkCollapsible').is(":hidden")) { //Indentation changed without clearing
			pcex.hideCheckCollapsible();
			$('#check-button').attr("disabled", false);
			pcex.clearAllWrongBlankLinesHighlight();
		}

		if (!$('#hint-div').is(":hidden")) { //Indentation changed without clearing
			pcex.clearHint();
			pcex.clearAllWrongBlankLinesHighlight();
		}
	},

	handleDraggedTileSwap: function (event, ui) {
		$('#tiles').removeClass('ui-state-highlight hovered');
		pcex.handleTileDrop(ui.draggable, this);
	},

	makeFilledBlankLineDraggable: function (blankLine, droppedTileData) {
		blankLine.data('tile', droppedTileData).draggable({
			containment: $('#draggable'),
			stack: $('#draggable'),
			helper: 'clone',
			//cursorAt: { top: blankLine.height()/2, left: droppedTileData.line.content.length * 10 },
			start: function () {
				$('.ui-draggable-dragging').addClass('tile-dragging-start');
				$('.code-blank-line').addClass('ui-state-highlight');
				$('.tile-blank-line').addClass('tile-blank-line-highlight');
			},
			stop: function () {
				$('.code-blank-line').removeClass('ui-state-highlight');
				$('.tile-blank-line').removeClass('tile-blank-line-highlight');
			}
		});
	},

	getTextNode: function (element) {
		return $(element).contents().filter(function () { return this.nodeType === Node.TEXT_NODE; })[0];
	},

	shuffleArray: function (array) {
		for (var i = array.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = array[i];
			array[i] = array[j];
			array[j] = temp;
		}
		return array;
	},

	next: function () {
		if (pcex.currentGoalIndex + 1 < pcex.numberOfGoals) {
			$('#back-button').attr('disabled', false).addClass('waves-effect waves-light').show();

			pcex.currentGoalIndex++;
			pcex.resetFields();
			pcex.clearScreen();
			pcex.init();

			if (!pcex.goalSolvedStates[pcex.currentGoalIndex] || pcex.isInLastGoal) {
				// $('#next-button').removeClass('btn-primary btn-challenge waves-effect waves-light').attr('disabled', true);

				if (pcex.isInLastGoal) {
					$('#shortcut-next-button').attr('disabled', true).hide();
					$('#next-button').hide();
				} else {
					pcex.updateNextButtonText();
				}
			}
		}
	},

	back: function () {
		if (pcex.currentGoalIndex > 0) {
			pcex.saveGoalState();

			pcex.currentGoalIndex--;
			pcex.resetFields();
			pcex.clearScreen();
			pcex.init();

			$('#next-button').attr('disabled', false).addClass('waves-effect waves-light').show();
			$('#shortcut-next-button').attr('disabled', false).show();
			if (pcex.currentGoalIndex == 0) {
				$('#back-button').removeClass('btn-primary btn-challenge waves-effect waves-light').attr('disabled', true);
			}

			pcex.updateNextButtonText();
		}
	},

	clearScreen: function () {
		$('#tiles').empty();
		$('#explanation').empty();
		$('#div_code').empty();
		pcex.hideCheckCollapsible();
		$('#show-correct-button').hide();
		$('#check-button').attr("disabled", true);
		$('#scrollable').css('top', 0);
	},

	resetFields: function () {
		pcex.lineList = null;
		pcex.blankLines = [];
		pcex.blankLineIDs = [];
		pcex.blankLineNumbers = [];
		pcex.tiles = [];
		pcex.droppedTiles = null;
		pcex.hiddenTiles = null;
		pcex.droppedTileIndentation = null;
		pcex.numberOfTrials = 0;
		pcex.animationStarted = false;
		pcex.animationStepIndex = 0;
		pcex.linesWithExplanation = [];
		pcex.correctBlankLineIDs = [];
		pcex.indentedIncorrectBlanLineIDs = [];
	},

	saveGoalState: function () {
		pcex.lastChallengeState = {
			correctBlankLineIDs: pcex.correctBlankLineIDs,
			droppedTiles: pcex.droppedTiles,
			droppedTileIndentation: pcex.droppedTileIndentation,
			numberOfTrials: pcex.numberOfTrials
		};
	},

	loadGoalState: function () {
		if (pcex.lastChallengeState) {
			if (!pcex.goalSolvedStates[pcex.currentGoalIndex]) { //Need to handle if the challenge is not already solved
				pcex.droppedTileIndentation = pcex.lastChallengeState.droppedTileIndentation;
				pcex.numberOfTrials = pcex.lastChallengeState.numberOfTrials;

				$.each(pcex.lastChallengeState.droppedTiles, function (i, droppedTile) {
					if (droppedTile) {
						pcex.handleTileDrop($('#' + pcex.blankLineIDs[i]), $('#tile_' + droppedTile.id));
					}
				});
			}

			//This should be done after handling tile drops previously not to reset classes of blank lines
			pcex.correctBlankLineIDs = pcex.lastChallengeState.correctBlankLineIDs;
			pcex.higlightCorrectBlankLines(pcex.correctBlankLineIDs);
		}

		pcex.lastChallengeState = null;
	},

	check: function () {
		var result = true;
		var correctTiles = [];
		var wrongTiles = [];
		var wrongIndentedTiles = [];

		var correctLineNumbers = [];
		var incorrectLineNumbers = [];
		var incorrectIndentedLineNumbers = [];

		var wrongAnswers = [];
		pcex.correctBlankLineIDs = [];
		pcex.indentedIncorrectBlanLineIDs = [];

		pcex.numberOfTrials++;

		for (i = 0; i < pcex.blankLineIDs.length; i++) {
			if (pcex.droppedTiles[i].line.id != pcex.blankLineIDs[i].replace('line_', '')) { //check if droppedTiles are same with original blank lines
				wrongTiles.push(pcex.blankLineIDs[i]);
				incorrectLineNumbers.push(pcex.blankLines[i].line.number);
				wrongAnswers.push(pcex.droppedTiles[i].line.content);
				result = false;
			} else {
				correctTiles.push(pcex.blankLineIDs[i]);
				pcex.correctBlankLineIDs.push(pcex.blankLineIDs[i]);
				correctLineNumbers.push(pcex.blankLines[i].line.number);
			}
		}

		//Check if the alternative output is same as correct output
		if (result == false) {
			var droppedTilesInWrongOrder = true;

			for (i = 0; i < pcex.droppedTiles.length; i++) { //check if the solution has correct tiles but in wrong order
				if (pcex.blankLineNumbers.includes(pcex.droppedTiles[i].line.number) == false) {
					droppedTilesInWrongOrder = false;
					break;
				}
			}

			if (droppedTilesInWrongOrder) {
				var answerOutput = "";
				var droppedTileIds = $.map(pcex.droppedTiles, function (val, index) {
					return val.line.id;
				}).join(",");

				$.each(pcex.currentGoal.alternatives, function (i, alternative) {
					if (alternative.alternativeTileIds == droppedTileIds) {
						answerOutput = alternative.output;
					}
				});

				if (answerOutput == pcex.currentGoal.correctOutput) { // then show it is as correct
					result = true;
					wrongAnswers = [];
					wrongTiles = [];
					correctLineNumbers = correctLineNumbers.concat(incorrectLineNumbers);
					incorrectLineNumbers = [];
					correctTiles = correctTiles.concat(wrongTiles);
					pcex.correctBlankLineIDs = [].concat(correctTiles);
				}
			}
		}

		var indentResult = true;
		if (pcex.isPython) { //Check indentation
			for (i = 0; i < pcex.blankLineIDs.length; i++) {
				if (pcex.droppedTiles[i].line.indentLevel != pcex.droppedTileIndentation[i]) {
					wrongIndentedTiles.push(pcex.blankLineIDs[i]);
					pcex.indentedIncorrectBlanLineIDs.push(pcex.blankLineIDs[i]);

					incorrectIndentedLineNumbers.push(pcex.blankLines[i].line.number);
					wrongAnswers.push(pcex.droppedTiles[i].line.content);

					indentResult = false;
				}
			}

			correctTiles = $(correctTiles).not(wrongIndentedTiles).get();
			correctLineNumbers = $(correctLineNumbers).not(incorrectIndentedLineNumbers).get();
			pcex.correctBlankLineIDs = $(pcex.correctBlankLineIDs).not(wrongIndentedTiles).get();
		}

		pcex.higlightCorrectBlankLines(correctTiles);

		if (result) {
			if (indentResult) {
				$('#check-result-title').html(_text('check-result-correct'));
				$('#check-result-message').show();
				if (pcex.currentGoal.userInputList.length > 0) {
					var userInput = "<p class='modal-sub-title'>" + _text('user-input') + "</p><hr>" + pcex.constructUserInputPartFromProgramOutput(pcex.currentGoal.correctOutput) + '<hr>';
					var correctOutput = "<p class='modal-sub-title'>" + _text('output') + "</p><hr>" + pcex.extractProgramOutput(pcex.currentGoal.correctOutput);

					$('#check-result-message').html(userInput + correctOutput);
				} else {
					$('#check-result-message').html("<p class='modal-sub-title'>" + _text('output') + "</p><hr>" + pcex.currentGoal.correctOutput);
				}

				$('#check-result-block').removeClass('wrong').addClass('correct');
				if (!pcex.isInLastGoal) {
					$('#shortcut-next-button').show();
				}

				$('#clear-button').hide();
				$('#show-hint-button').hide();
				$('#show-message-details').hide();
				pcex.showCorrect();

				pcex.reportCheckResultToUm(true);
				pcex.trackCheckResult('correct', 1, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);

				pcex.numberOfTrials = 0;
			} else {
				$('#check-result-title').html(_text('incorrect-try-again'));
				pcex.numberOfTrials++;

				pcex.appendIncorrectResultMessage(wrongTiles, incorrectLineNumbers, wrongIndentedTiles, incorrectIndentedLineNumbers);
				pcex.higlightWrongBlankLines(wrongIndentedTiles);

				$('#check-result-block').removeClass('correct').addClass('wrong');
				$('#shortcut-next-button').hide();
				$('#show-message-details').hide();
				$('#clear-button').show();

				pcex.reportCheckResultToUm(false);
				pcex.trackCheckResult('indentation_err', 0, pcex.numberOfTrials, correctLineNumbers, incorrectIndentedLineNumbers, wrongAnswers);
			}
		} else {
			$('#check-result-title').html(_text('incorrect-try-again'));
			$('#show-message-details').hide();

			if (pcex.isPython) {
				pcex.higlightWrongBlankLines(wrongTiles.concat(wrongIndentedTiles));
				pcex.appendIncorrectResultMessage(wrongTiles, incorrectLineNumbers, wrongIndentedTiles, incorrectIndentedLineNumbers);

				pcex.trackCheckResult('wrong', 0, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);
			} else {
				pcex.higlightWrongBlankLines(wrongTiles);
				var droppedTileIds = $.map(pcex.droppedTiles, function (val, index) {
					return val.line.id;
				}).join(",");

				var alternativeOutput = '';

				$.each(pcex.currentGoal.alternatives, function (i, alternative) {
					if (alternative.alternativeTileIds == droppedTileIds) {
						alternativeOutput = alternative.output;
					}
				});

				if (alternativeOutput.toLowerCase().includes('infinite loop')) {
					$('#check-result-title').html(alternativeOutput);
					$('#check-result-message').hide();

					pcex.trackCheckResult('infinite_loop', 0, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);
				} else if (alternativeOutput.toLowerCase().includes('exception')) {
					$('#check-result-title').html(_text('your-program-throws-exception'));
					$('#check-result-message').hide();
					$('#show-message-details').show();

					$('#modal-output-div').hide();
					$('#modal-check-result-title').html(_text('exception-details'));
					$('#modal-check-result-div').show();
					$('#modal-check-result-message').html(alternativeOutput);

					pcex.trackCheckResult('exception', 0, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);
				} else if (alternativeOutput.toLowerCase().includes('error')) {
					$('#check-result-title').html(_text('your-program-has-compilation-error'));
					$('#check-result-message').hide();
					$('#show-message-details').show();

					$('#modal-output-div').hide();
					$('#modal-check-result-title').html(_text('compilation-error-details'));
					$('#modal-check-result-div').show();
					$('#modal-check-result-message').html(alternativeOutput);

					pcex.trackCheckResult('compilation_err', 0, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);
				} else {
					$('#check-result-message').show();
					$('#check-result-message').html(_text('your-program-output-is-different'));
					$('#show-message-details').show();

					$('#modal-check-result-title').html(_text('program-output-details'));

					var currentProgramOutputPart = pcex.extractProgramOutput(alternativeOutput);
					var expectedProgramOutputPart = pcex.extractProgramOutput(pcex.currentGoal.correctOutput);

					if (pcex.currentGoal.userInputList.length > 0) {
						var userInputPart = pcex.constructUserInputPartFromProgramOutput(alternativeOutput);
						$('#modal-check-result-div').show();
						$('#modal-check-result-message').html("<p class='modal-sub-title'>" + _text('user-input') + "</p>" + userInputPart);
					} else {
						$('#modal-check-result-message').empty();
						$('#modal-check-result-div').hide();
					}


					$('#modal-output-div').show();
					$('#modal-current-output-message').html(currentProgramOutputPart);
					$('#modal-expected-output-message').html(expectedProgramOutputPart);

					pcex.trackCheckResult('wrong_output', 0, pcex.numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers);
				}
			}

			$('#check-result-block').removeClass('correct').addClass('wrong');
			$('#shortcut-next-button').hide();
			$('#clear-button').show();

			pcex.reportCheckResultToUm(false);
		}

		$('#check-button').attr("disabled", true);

		if ((!indentResult || !result)) {
			if (pcex.numberOfTrials >= pcex.maxNumberOfTrials) {
				$('#show-correct-button').show();
			}

			if (pcex.numberOfTrials >= pcex.numberOfTrialsForHint) {
				$('#show-hint-button').show();
			}
		}

		setTimeout(() => pcex.resizeIframe(), 300);
	},

	appendIncorrectResultMessage: function (incorrectLines, incorrectLineNumbers, incorrectIndentedLines, incorrectIndentedLineNumbers) {
		var incorrectResultDiv = document.createElement('div');
		$(incorrectResultDiv).css('display', 'grid');
		if (incorrectLines.length > 0) {
			var resultMessage = pcex.createIncorrectResultMessage(incorrectLines, incorrectLineNumbers, _text('is-incorrect'), _text('are-incorrect'));
			$(incorrectResultDiv).append(resultMessage);
		}

		incorrectIndentedLines = $(incorrectIndentedLines).not(incorrectLines).get();
		incorrectIndentedLineNumbers = $(incorrectIndentedLineNumbers).not(incorrectLineNumbers).get();


		if (incorrectIndentedLines.length > 0) {
			var resultMessage = pcex.createIncorrectResultMessage(incorrectIndentedLines, incorrectIndentedLineNumbers, _text('has-indentation-error'), _text('have-indentation-error'));
			$(incorrectResultDiv).append(resultMessage);
		}

		$('#check-result-message').append(incorrectResultDiv);

	},

	createIncorrectResultMessage: function (incorrectLines, incorrectLineNumbers, singularText, pluralText) {
		var errorLineNumbers = document.createElement('span');

		for (i = 0; i < incorrectLines.length; i++) {
			var errorLine = document.createElement('a');
			$(errorLine).html("line " + incorrectLineNumbers[i]).css({ 'color': '#0275d8', 'cursor': 'pointer', 'border': '2px solid blue' }).attr('wrongTile', incorrectLines[i]);
			$(errorLine).click(pcex.blinkWrongLine);

			$(errorLineNumbers).append(errorLine);

			if (i != incorrectLineNumbers.length - 1) {
				$(errorLineNumbers).append(document.createTextNode(","));
			}
		}

		var errorMessage = "";

		if (incorrectLines.length == 1) {
			errorMessage = " " + singularText;
		} else {
			errorMessage = " " + pluralText;
		}

		var errorNode = document.createTextNode(errorMessage);
		$(errorLineNumbers).append(errorNode);

		return errorLineNumbers;
	},

	clearIncorrectAnswer: function () {
		$('.code-blank-line-error').removeClass().html("\n").addClass("code-blank-line ui-state-default");

		$.each(pcex.hiddenTiles, function (i, tile) {
			if (pcex.correctBlankLineIDs.includes(pcex.blankLineIDs[i]) == false) {
				$(tile).show();
				pcex.droppedTiles[i] = undefined;
				pcex.droppedTileIndentation[i] = 0;
			} else {
				pcex.hiddenTiles[i] = undefined;
			}
		});

		pcex.hideCheckCollapsible();
		$('#check-result-title').empty();
		$('#modal-check-result-title').empty();
		$('#modal-check-result-message').empty();
		$('#modal-current-output-message').empty();
		$('#modal-expected-output-message').empty();

		pcex.resizeIframe();
	},

	constructUserInputPartFromProgramOutput: function (output) {
		if (pcex.currentGoal.userInputList && pcex.currentGoal.userInputList.length > 0) {
			var outputLines = output.split("\n");
			var inputIndex = 0;
			var outputLineIndex = 0;
			while (outputLineIndex < outputLines.length) {
				var outputLine = outputLines[outputLineIndex];
				if (outputLine.includes('Enter') && pcex.currentGoal.userInputList[inputIndex]) {
					outputLines[outputLineIndex] = outputLine + "<span class='input_text'>" + pcex.currentGoal.userInputList[inputIndex].replace(/,/g, ' ') + "</span>";
					inputIndex++;
				} else {
					outputLines[outputLineIndex] = "";
				}

				outputLineIndex++;
			}

			output = outputLines.filter(function (line) { return line.length > 0; }).join("\n");
		}

		return output;
	},

	extractProgramOutput: function (output) {
		var outputLines = output.split("\n");
		var extractedOutput = "";
		$.each(outputLines, function (i, outputLine) {
			if (!outputLine.includes('Enter')) {
				extractedOutput = extractedOutput + outputLine + "\n";
			}
		});

		return extractedOutput;
	},

	showResultMessageDetails: function () {
		$('#result-modal').modal('open');

		$('#result-modal').draggable({
			cursor: 'move',
			handle: '#modal-check-result-title'
		});

		pcex.trackHint('evaluation_details', 0);
		pcex.resizeIframe();
	},

	higlightCorrectBlankLines: function (blankLineIds) {
		$.each(blankLineIds, function (i, blankLineId) {
			var blankLineElement = $('#' + blankLineId);
			if (blankLineElement.hasClass('code-blank-line-correct') == false) {
				blankLineElement.removeClass().addClass('line code-blank-line-correct');

				if (pcex.isPython) { //Disable indent buttons if it is Python challenge
					var blankLineIndex = pcex.blankLineIDs.indexOf(blankLineId);
					$('#increase-indent-button-' + blankLineIndex).hide();
					$('#decrease-indent-button-' + blankLineIndex).hide();
				}
			}

			if (blankLineElement.data('ui-draggable')) {
				blankLineElement.draggable('destroy');
			}

			if (blankLineElement.data('ui-droppable')) {
				blankLineElement.droppable('destroy');
			}

		});
	},

	higlightWrongBlankLines: function (blankLineIds) {
		$.each(blankLineIds, function (i, blankLineId) {
			$('#' + blankLineId).removeClass('tile-dragged').addClass('code-blank-line-error');
		});
	},

	blinkWrongLine: function (wrongTile) {
		$("#" + $(wrongTile.currentTarget).attr('wrongTile')).addClass('blink-me-error');

		$("#" + $(wrongTile.currentTarget).attr('wrongTile')).one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
			function (e) {
				$("#" + $(wrongTile.currentTarget).attr('wrongTile')).removeClass('blink-me-error');
			});
	},


	clearAllWrongBlankLinesHighlight: function () {
		$.each(pcex.blankLineIDs, function (i, blankLineId) {
			$('.code-blank-line-error').removeClass('code-blank-line-error').addClass('tile-dragged');
		});
	},

	showMeCorrectSolution: function () {
		pcex.goalShowResultStates[pcex.currentGoalIndex] = true;
		pcex.activityType = 'ch_not_solved';
		pcex.trackUserActivity();
		pcex.showCorrect();

		pcex.resizeIframe();
	},

	fixBrokenHelpIcons() {
		// find the help icons has was mistakenly highlighted as code
		$('i.material-icons > span.hljs-comment:contains("help")').each((i, el) => el.parentElement.innerHTML = 'help');
	},

	showCorrect: function () {
		pcex.goalSolvedStates[pcex.currentGoalIndex] = true;
		$.each(pcex.currentGoal.blankLineList, function (i, blankLine) {
			var lineContent = pcex.createLineContent(blankLine.line, false, false);

			$("#line_" + blankLine.line.id).replaceWith(lineContent);
			hljs.highlightBlock(lineContent);
			pcex.fixBrokenHelpIcons();
		});

		$.each(pcex.currentGoal.lineList, function (i, line) {
			const helpBtn = $("#help_" + line.id);
			helpBtn.unbind('click').click(pcex.handleHelpButtonClicked).show();
			helpBtn.next().css('margin-left', '5px');
		});

		pcex.higlightCorrectBlankLines(pcex.blankLineIDs);

		//TODO: make this part reusable and use it in next function as well
		if (pcex.currentGoalIndex != pcex.numberOfGoals - 1) {
			$('#next-button').removeClass('btn-primary').addClass('btn-challenge').attr('disabled', false).addClass('waves-effect waves-light');
		}
		pcex.displayAsFullyWorkedOut();
	},

	getSourceCode: function () {
		var sourceCode = "";
		$.each(pcex.currentGoal.lineList, function (i, line) {
			var index = $.inArray('line_' + line.id, pcex.blankLineIDs);
			if (index < 0) {
				sourceCode += line.content + "\n";
			} else {
				if (pcex.droppedTiles[index]) {
					sourceCode += pcex.getIndentedCode(pcex.droppedTiles[index].line, true, index) + "\n";
				} else {
					sourceCode += pcex.commentString + _text('fill-in-your-code-here') + "\n";
				}
			}

		});

		return sourceCode;
	},

	changeStyleToFullyWorkedOut: function () {
		$('#check-button').hide();
		$('#stop-animation-button').hide();
		$('#animation-next-button').hide();
		$('#animation-back-button').hide();
		$('#start-animation-button').show();
		$('#goal_description').html(pcex.currentGoal.goalDescription);
		$('#goal_title').removeClass('primary-challenge-color').addClass('primary-color');

		$('#next-button').removeClass('btn-challenge').addClass('btn-primary');

		if (!$('#back-button').attr("disabled")) {
			$('#back-button').removeClass('btn-challenge').addClass('btn-primary');
		}

		$('#explanation-div').hide();
		$('#drag-tile-div').hide();
	},

	displayAsFullyWorkedOut: function () {
		$('#check-button').hide();
		$('#stop-animation-button').hide();
		$('#animation-next-button').hide();
		$('#animation-back-button').hide();
		$('#start-animation-button').show();
		$('#goal_description').html(pcex.currentGoal.goalDescription);
		$('#explanation-div').hide();
		$('#drag-tile-div').hide();
		pcex.hideCheckCollapsible();
		$('#show-correct-button').hide();

	},

	changeStyleToChallenge: function () {
		$('#start-animation-button').hide();
		$('#stop-animation-button').hide();
		$('#animation-next-button').hide();
		$('#animation-back-button').hide();
		$('#check-button').show();


		$('#next-button').removeClass('btn-primary').addClass('btn-challenge');


		if ($('#back-button').hasClass('pcex_button') == false) {
			$('#back-button').removeClass().addClass('pcex_button btn-sm btn-responsive btn-challenge waves-effect waves-light');
		} else {
			$('#back-button').removeClass('btn-primary').addClass('btn-challenge');
		}

		$('#goal_description').html(pcex.currentGoal.goalDescription + "<br><br>" + _text('drag-a-tile-to-construct'));
		$('#goal_title').removeClass('primary-color').addClass('primary-challenge-color');
		$('#drag-tile-div').show();
		$('#explanation-div').hide();
	},

	startAnimationClick: function (event) {
		pcex.startAnimation(false)
	},

	startAnimation: function (helpButtonClicked) {
		pcex.animationStarted = true;
		$('#start-animation-button').hide();
		$('#start-animation-shortcut-button').hide();
		$('#stop-animation-button').show();
		$('#animation-next-button').show();
		$('#animation-back-button').show();

		$('#explanation').empty();
		$('#explanation-div').show();
		pcex.hideCheckCollapsible();

		pcex.addAnimationExplanation(helpButtonClicked);
	},

	createHelpWindowContent: function (line, disableNavigation, tile) {
		const is_distractor_explanation = tile?.commentList?.join('').trim().length > 0;

		// use tile's comments instead of line's comments
		// this will show distractor's explanation instead of line's explanation
		let org_line = null;
		if (is_distractor_explanation) {
			org_line = line;
			line = tile;
		}

		var helpDiv = document.createElement('div');
		$(helpDiv).attr('id', 'help_comment_' + line.id);
		$(helpDiv).attr('help_index', 0);

		$.each(line.commentList, function (i, comment) {
			var helpText = comment.replace(/"/g, '\'');
			var helpNode = document.createElement('p');
			$(helpNode).css('text-align', 'justify');
			$(helpNode).html(helpText + "<br>");
			$(helpDiv).append(helpNode);

			if (i > 0) { //Just show the first level comment
				$(helpNode).hide();
			}
		});

		if (!disableNavigation && line.commentList.length > 1) {
			var helpBackButton = document.createElement('a');
			$(helpBackButton).attr('id', 'help_back_line_' + line.id).addClass('btn btn-info btn-sm').html(_text('previous')).attr('disabled', true);
			$(helpDiv).append(helpBackButton);

			var helpNextButton = document.createElement('a');
			$(helpNextButton).attr('id', 'help_next_line_' + line.id).addClass('btn btn-info btn-sm').html(_text('additional-details'));
			$(helpDiv).append(helpNextButton);
		}

		if (is_distractor_explanation) {
			$(helpDiv).append(pcex.getDistractorExplanationFeedbackUI(org_line, tile));
		} else if (isWeatPCEX(pcex.currentGoal.name)) { // line explanation
			$(helpDiv).append(pcex.getLineExplanationFeedbackUI(line));
		}

		var wrapper = document.createElement('div');
		$(wrapper).append(helpDiv);

		return wrapper;
	},

	getDistractorExplanationFeedbackUI: function (line, tile) {
		const feedback_ui = $(`
			<div style="margin-top:10px;">
				<input type="hidden" name="distractor-explanation-line" />
				<input type="hidden" name="distractor-explanation-tile" />
				<span id="distractor-explanation-provide-feedback-btn">${_text('provide-feedback')}</span>
				<div id="distractor-explanation-feedback-ui" style="display:none;">
					<table >
						<tr>
							<td><b>${_text('helpful-explanation-instruction')}</b></td>
						</tr>
						<tr>
							<td>${_text('it-clearly-explained-why-this-option-is-wrong')}</td>
						</tr>
						<tr>
							<td>
								<div class="controls">
								<label><span>1</span><input type="radio" name="helpful-explanation-it-clearly-explained-why-this-option-is-wrong" value="1"/></label>
								<label><span>2</span><input type="radio" name="helpful-explanation-it-clearly-explained-why-this-option-is-wrong" value="2"/></label>
								<label><span>3</span><input type="radio" name="helpful-explanation-it-clearly-explained-why-this-option-is-wrong" value="3"/></label>
								<label><span>4</span><input type="radio" name="helpful-explanation-it-clearly-explained-why-this-option-is-wrong" value="4"/></label>
								<label><span>5</span><input type="radio" name="helpful-explanation-it-clearly-explained-why-this-option-is-wrong" value="5"/></label>
								</div>
							</td>
						</tr>
						<tr>
							<td>${_text('it-clarified-a-misconception-i-didnt-realize-i-had')}</td>
						</tr>
						<tr>
							<td>
								<div class="controls">
								<label><span>1</span><input type="radio" name="helpful-explanation-it-clarified-a-misconception-i-didnt-realize-i-had" value="1"/></label>
								<label><span>2</span><input type="radio" name="helpful-explanation-it-clarified-a-misconception-i-didnt-realize-i-had" value="2"/></label>
								<label><span>3</span><input type="radio" name="helpful-explanation-it-clarified-a-misconception-i-didnt-realize-i-had" value="3"/></label>
								<label><span>4</span><input type="radio" name="helpful-explanation-it-clarified-a-misconception-i-didnt-realize-i-had" value="4"/></label>
								<label><span>5</span><input type="radio" name="helpful-explanation-it-clarified-a-misconception-i-didnt-realize-i-had" value="5"/></label>
								</div>
							</td>
						</tr>
						
						<tr><td>${_text('here-is-what-i-would-add-change-in-this-explanation')}</td></tr>
						<tr><td><textarea name="helpful-explanation-open-feedback"></textarea></td></tr>
						<tr><td><button type="button">${_text('submit-feedback')}</button></td></tr>
						<tr><td id="helpful-explanation-submission-feedback"></td></tr>
					</table>
				</div>
			</div>`);
		feedback_ui.find('input[name="distractor-explanation-line"]').attr('value', JSON.stringify(line));
		feedback_ui.find('input[name="distractor-explanation-tile"]').attr('value', JSON.stringify(tile));
		return feedback_ui;
	},

	getLineExplanationFeedbackUI: function (line) {
		const feedback_ui = $(`
			<form style="margin-top:10px;">
				<input type="hidden" name="line-explanation-line" />
				<span id="line-explanation-provide-feedback-btn">${_text('provide-feedback')}</span>
				<div id="line-explanation-feedback-ui" style="display:none;">
					<table >
						<tr>
							<td><b>${_text('helpful-explanation-instruction')}</b></td>
						</tr>
						<tr>
							<td>${_text('it-is-clear-and-easy-to-understand')}</td>
						</tr>
						<tr>
							<td>
								<div class="controls">
								<label><span>1</span><input type="radio" name="helpful-explanation-it-is-clear-and-easy-to-understand" value="1"/></label>
								<label><span>2</span><input type="radio" name="helpful-explanation-it-is-clear-and-easy-to-understand" value="2"/></label>
								<label><span>3</span><input type="radio" name="helpful-explanation-it-is-clear-and-easy-to-understand" value="3"/></label>
								<label><span>4</span><input type="radio" name="helpful-explanation-it-is-clear-and-easy-to-understand" value="4"/></label>
								<label><span>5</span><input type="radio" name="helpful-explanation-it-is-clear-and-easy-to-understand" value="5"/></label>
								</div>
							</td>
						</tr>
						<tr>
							<td>${_text('it-helped-me-understand-the-purpose-of-the-line')}</td>
						</tr>
						<tr>
							<td>
								<div class="controls">
								<label><span>1</span><input type="radio" name="helpful-explanation-it-helped-me-understand-the-purpose-of-the-line" value="1"/></label>
								<label><span>2</span><input type="radio" name="helpful-explanation-it-helped-me-understand-the-purpose-of-the-line" value="2"/></label>
								<label><span>3</span><input type="radio" name="helpful-explanation-it-helped-me-understand-the-purpose-of-the-line" value="3"/></label>
								<label><span>4</span><input type="radio" name="helpful-explanation-it-helped-me-understand-the-purpose-of-the-line" value="4"/></label>
								<label><span>5</span><input type="radio" name="helpful-explanation-it-helped-me-understand-the-purpose-of-the-line" value="5"/></label>
								</div>
							</td>
						</tr>
						
						<tr><td>${_text('here-is-what-i-would-add-change-in-this-explanation')}</td></tr>
						<tr><td><textarea name="helpful-explanation-open-feedback"></textarea></td></tr>
						<tr><td><button type="button">${_text('submit-feedback')}</button></td></tr>
						<tr><td id="helpful-explanation-submission-feedback"></td></tr>
					</table>
				</div>
			</form>`);
		feedback_ui.find('input[name="line-explanation-line"]').attr('value', JSON.stringify(line));
		return feedback_ui;
	},

	handleDistractorExplanationFeedbackSubmit: function () {
		const feedbacks = {
			'activity-id': pcex.jsonData['id'],
			'activity-name': cleanName(pcex.jsonData['activityName']),
			'goal-id': pcex.currentGoal.id,
			'goal-name': cleanName(pcex.currentGoal.name),
			'user-usr': pcex.userCredentials?.usr,
			'user-group': pcex.userCredentials?.grp,
			'user-session-id': pcex.userCredentials?.sid,
			'user-svc': pcex.userCredentials?.svc,
			'line': JSON.parse($('input[name="distractor-explanation-line"]').val()),
			'tile': JSON.parse($('input[name="distractor-explanation-tile"]').val()),
			feedback: $('textarea[name="helpful-explanation-open-feedback"]').val(),
		};
		$('#distractor-explanation-feedback-ui input[type="radio"]:checked').each(function () {
			feedbacks[$(this).attr('name').replace('helpful-explanation-', '')] = $(this).val();
		});

		$.ajax({
			type: 'POST',
			url: (
				location.href.startsWith('http://localhost:3000') ?
					'http://localhost:3000' : 'http://adapt2.sis.pitt.edu/pcex-authoring'
			) + '/api/distractor-explanation/feedback',
			data: JSON.stringify(feedbacks),
			contentType: 'application/json',
			dataType: 'json',
			success: function (response) {
				$('#helpful-explanation-submission-feedback').html(`
					<span style="color:green;">${_text('feedback-submitted-successfully')}</span>	
				`);
			},
			error: function () {
				$('#helpful-explanation-submission-feedback').html(`
					<span style="color:red;">${_text('feedback-submission-error')}</span>	
				`);
			},
			complete: function () {
				setTimeout(() => {
					$('#helpful-explanation-submission-feedback').html(``);
				}, 5000);
			}
		});
	},

	handleDistractorExplanationFeedbackToggle: function () {
		const feedbacks = {
			'activity-id': pcex.jsonData['id'],
			'activity-name': cleanName(pcex.jsonData['activityName']),
			'goal-id': pcex.currentGoal.id,
			'goal-name': cleanName(pcex.currentGoal.name),
			'user-usr': pcex.userCredentials?.usr,
			'user-group': pcex.userCredentials?.grp,
			'user-session-id': pcex.userCredentials?.sid,
			'user-svc': pcex.userCredentials?.svc,
			'line': JSON.parse($('input[name="distractor-explanation-line"]').val()),
			'tile': JSON.parse($('input[name="distractor-explanation-tile"]').val()),
			'toggle': $('#distractor-explanation-feedback-ui').is(':visible') ? 'hide' : 'show',
		};

		$.ajax({
			type: 'POST',
			url: (
				location.href.startsWith('http://localhost:3000') ?
					'http://localhost:3000' : 'http://adapt2.sis.pitt.edu/pcex-authoring'
			) + '/api/distractor-explanation/feedback',
			data: JSON.stringify(feedbacks),
			contentType: 'application/json',
			dataType: 'json',
			success: function (response) { },
			error: function () { },
			complete: function () {
				$('#distractor-explanation-feedback-ui').toggle();
			}
		});
	},

	handleLineExplanationFeedbackSubmit: function () {
		const feedbacks = {
			'activity-id': pcex.jsonData['id'],
			'activity-name': cleanName(pcex.jsonData['activityName']),
			'goal-id': pcex.currentGoal.id,
			'goal-name': cleanName(pcex.currentGoal.name),
			'user-usr': pcex.userCredentials?.usr,
			'user-group': pcex.userCredentials?.grp,
			'user-session-id': pcex.userCredentials?.sid,
			'user-svc': pcex.userCredentials?.svc,
			'line': {
				...JSON.parse($('input[name="line-explanation-line"]').val()),
				index: parseInt($('#line-explanation-feedback-ui').closest('[help_index]').attr('help_index')),
			},
			feedback: $('textarea[name="helpful-explanation-open-feedback"]').val(),
		};
		$('#line-explanation-feedback-ui input[type="radio"]:checked').each(function () {
			feedbacks[$(this).attr('name').replace('helpful-explanation-', '')] = $(this).val();
		});

		$.ajax({
			type: 'POST',
			url: (
				location.href.startsWith('http://localhost:3000') ?
					'http://localhost:3000' : 'http://adapt2.sis.pitt.edu/pcex-authoring'
			) + '/api/distractor-explanation/feedback',
			data: JSON.stringify(feedbacks),
			contentType: 'application/json',
			dataType: 'json',
			success: function (response) {
				$('#helpful-explanation-submission-feedback').html(`
					<span style="color:green;">${_text('feedback-submitted-successfully')}</span>	
				`);
			},
			error: function () {
				$('#helpful-explanation-submission-feedback').html(`
					<span style="color:red;">${_text('feedback-submission-error')}</span>	
				`);
			},
			complete: function () {
				setTimeout(() => {
					$('#helpful-explanation-submission-feedback').html(``);
				}, 5000);
			}
		});
	},

	handleLineExplanationFeedbackToggle: function () {
		const feedbacks = {
			'activity-id': pcex.jsonData['id'],
			'activity-name': cleanName(pcex.jsonData['activityName']),
			'goal-id': pcex.currentGoal.id,
			'goal-name': cleanName(pcex.currentGoal.name),
			'user-usr': pcex.userCredentials?.usr,
			'user-group': pcex.userCredentials?.grp,
			'user-session-id': pcex.userCredentials?.sid,
			'user-svc': pcex.userCredentials?.svc,
			'line': {
				...JSON.parse($('input[name="line-explanation-line"]').val()),
				index: parseInt($('#line-explanation-feedback-ui').closest('[help_index]').attr('help_index')),
			},
			'toggle': $('#line-explanation-feedback-ui').is(':visible') ? 'hide' : 'show',
		};

		$.ajax({
			type: 'POST',
			url: (
				location.href.startsWith('http://localhost:3000') ?
					'http://localhost:3000' : 'http://adapt2.sis.pitt.edu/pcex-authoring'
			) + '/api/distractor-explanation/feedback',
			data: JSON.stringify(feedbacks),
			contentType: 'application/json',
			dataType: 'json',
			success: function (response) { },
			error: function () { },
			complete: function () {
				$('#line-explanation-feedback-ui').toggle();
			}
		});
	},

	stopAnimationClick: function () {
		pcex.stopAnimation()
	},

	stopAnimation: function () {
		$('#start-animation-button').show();
		$('#stop-animation-button').hide();
		$('#animation-next-button').hide();
		$('#animation-back-button').hide();
		$('#animation-back-button').attr('disabled', true);
		$('#explanation-div').hide();
		$('#explanation').empty();

		var line = pcex.linesWithExplanation[pcex.animationStepIndex];
		$('#line_' + line.id).removeClass('animation-highlight blink-me');

		pcex.animationStepIndex = 0;
		pcex.animationStarted = false;

		pcex.resizeIframe();
	},

	animationNext: function () {
		if (pcex.animationStepIndex > -1) {
			var line = pcex.linesWithExplanation[pcex.animationStepIndex];
			$('#line_' + line.id).removeClass('animation-highlight blink-me');
		}

		$('#explanation').empty();

		pcex.animationStepIndex++;
		pcex.addAnimationExplanation();
	},

	animationBack: function () {
		if (pcex.animationStepIndex > 0) {
			var line = pcex.linesWithExplanation[pcex.animationStepIndex];
			$('#line_' + line.id).removeClass('animation-highlight blink-me');
			$('#explanation').empty();

			pcex.animationStepIndex--;
			pcex.addAnimationExplanation();
		}
	},

	hideAllHelpButtons: function () {
		$.each(pcex.linesWithExplanation, function (i, line) {
			$('#help_' + line.id).hide();
		});
	},

	addAnimationExplanation: function (helpButtonClicked) {
		if (pcex.animationStepIndex > -1 && pcex.animationStepIndex < pcex.linesWithExplanation.length) {
			var line = pcex.linesWithExplanation[pcex.animationStepIndex];

			$('#line_' + line.id).addClass('animation-highlight');
			var helpContent = pcex.createHelpWindowContent(line);
			$('#explanation').append(helpContent).show();

			pcex.reportLineClicksToUm(line.number);
			if (!helpButtonClicked) { //helpButton clicks tracked separately
				pcex.trackExplanation('sequential', 1, line.number);
			}

			$(helpContent).find("a[id^='help_back']").click(function () {
				var line = pcex.linesWithExplanation[pcex.animationStepIndex];
				$('#line_' + line.id).removeClass('blink-me');
				var comments = $(this).parent().find('p');
				var commentLength = comments.length;
				var helpDiv = $(helpContent).find("div[id^='help_comment']");
				var index = parseInt(helpDiv.attr('help_index'));

				if (0 < index) {
					$(comments[index - 1]).show();
					$(comments[index]).hide();
					helpDiv.attr('help_index', --index);
					$(this).parent().find("a[id^='help_next']").attr('disabled', false);
				}

				if (index == 0) {
					$(this).attr('disabled', true);
				}

				pcex.trackExplanation('sequential', index + 1, line.number);

				return $('#line_' + line.id).addClass('blink-me');
			});

			$(helpContent).find("a[id^='help_next']").click(function () {
				var line = pcex.linesWithExplanation[pcex.animationStepIndex];
				$('#line_' + line.id).removeClass('blink-me');
				var comments = $(this).parent().find('p');
				var commentLength = comments.length;
				var helpDiv = $(helpContent).find("div[id^='help_comment']");
				var index = parseInt(helpDiv.attr('help_index'));

				if (index < commentLength) {
					$(comments[index + 1]).show();
					$(comments[index]).hide();
					helpDiv.attr('help_index', ++index);
					$(this).parent().find("a[id^='help_back']").attr('disabled', false);
				}

				if (index + 1 == commentLength) {
					$(this).attr('disabled', true);
				}

				pcex.trackExplanation('sequential', index + 1, line.number);

				// reset feedback-ui
				helpDiv.find('form').trigger("reset");
				helpDiv.find('#line-explanation-feedback-ui').hide();

				return $('#line_' + line.id).addClass('blink-me');
			});

			var lineOffsetPosition = $('#line_' + line.id).offset().top + 20;

			var docViewTop = $(window).scrollTop();
			var docViewBottom = docViewTop + $(window).height();

			var explanationTop = $('#scrollable').position().top;
			var explanationBottom = explanationTop + $('#scrollable-content').height();

			if (((docViewTop < explanationTop) && (docViewBottom > explanationBottom)) == false ||
				(((lineOffsetPosition > docViewTop) && (lineOffsetPosition < docViewBottom)) == false)) {
				var lineRelativePosition = $('#line_' + line.id).position().top;
				$('#scrollable').css('top', lineRelativePosition);
				$(window).scrollTop(lineRelativePosition);
			}

			if (pcex.animationStepIndex == 0) {
				$('#animation-back-button').attr('disabled', true);
			} else {
				$('#animation-back-button').attr('disabled', false);
			}

			if (pcex.animationStepIndex == pcex.linesWithExplanation.length - 1) {
				$('#animation-next-button').attr('disabled', true);
			} else {
				$('#animation-next-button').attr('disabled', false);
			}

			pcex.resizeIframe();
		}
	},

	showHint: function () {
		var relatedBlankLine;
		var relatedBlankLineIndex;
		var showIndentationHint = false;

		for (i = 0; i < pcex.blankLineIDs.length; i++) {
			var lineId = pcex.blankLineIDs[i];
			if (!pcex.correctBlankLineIDs.includes(lineId)) {
				relatedBlankLine = pcex.blankLines[i];
				relatedBlankLineIndex = i;

				if (pcex.indentedIncorrectBlanLineIDs.includes(lineId)) {
					showIndentationHint = true;
				}

				break;
			}
		}

		$('#line_' + relatedBlankLine.line.id).removeClass('code-blank-line-error').addClass('tile-dragged hint-highlight');

		var hintContent;

		if (showIndentationHint) {
			hintContent = document.createElement('div');
			var indentationMessage;
			var currentIndentLevel = pcex.droppedTileIndentation[i];
			var requiredIndentLevel = relatedBlankLine.line.indentLevel;
			var levelDifference = 0;

			if (currentIndentLevel < requiredIndentLevel) {
				indentationMessage = _text('increase-indentation-by').replace('lineNumber', `${relatedBlankLine.line.number}`).replace('levelDifference', `${levelDifference}`);
				levelDifference = requiredIndentLevel - currentIndentLevel;
			} else {
				indentationMessage = _text('decrease-indentation-by').replace('lineNumber', `${relatedBlankLine.line.number}`).replace('levelDifference', `${levelDifference}`);
				levelDifference = currentIndentLevel - requiredIndentLevel;
			}

			var messageSpan = document.createElement('span');
			$(messageSpan).html(indentationMessage);
			$(hintContent).append(messageSpan);

		} else {
			hintContent = pcex.createHelpWindowContent(
				relatedBlankLine.line, true,
				pcex.droppedTiles[relatedBlankLineIndex].line // pass the tile too
			);
		}

		pcex.trackHint('explanation', relatedBlankLine.line.number);

		$('#hint').append(hintContent);
		$('#hint-div').show();
		pcex.hideCheckCollapsible();

		pcex.resizeIframe();
	},

	clearHint: function () {
		$('.hint-highlight').removeClass('hint-highlight');
		$('#hint').empty();
		$('#hint-div').hide();

		pcex.makeCheckButtonEnabledIfTilesFilled();

		pcex.resizeIframe();
	},

	handleHelpButtonClicked: function (element) {
		pcex.stopAnimation();
		var clickedHelpButtonIndex = -1;
		var clickedHelpButtonLindeNumber = -1;

		$.each(pcex.linesWithExplanation, function (i, line) {
			if (line.id == $(element.currentTarget).attr('id').replace('help_', '')) {
				clickedHelpButtonIndex = i;
				clickedHelpButtonLindeNumber = line.number;
			}
		});

		pcex.trackExplanation('free', 1, clickedHelpButtonLindeNumber);

		pcex.animationStepIndex = clickedHelpButtonIndex;
		pcex.startAnimation(true);
	},

	overlayFadeOut: function () {
		$('#overlay').fadeOut(300, function () {
			$('.decrease-indent-button').css('z-index', '1');
			$('.increase-indent-button').css('z-index', '1');
			$('.decrease-indent-button').webuiPopover('destroy');
			$('.increase-indent-button').webuiPopover('destroy');
			$('#goal_column').css('z-index', '1');
		});
	},

	hideCheckCollapsible: function () {
		if (!$('#checkCollapsible').is(":hidden")) {
			$('#check-result-message').empty();
			try {
				$('#checkCollapsible').collapse('hide');
			}
			catch (err) {
				//To catch 'Uncaught Error: Collapse is transitioning' of bootstrap. Alpha version has this problem need to update bootstrap
			}
		}
	},

	isScrollNeeded: function () {
		return pcex.currentGoal.lineList.length > pcex.scrollLineLimit;
	},

	highlightGoalTitle: function () {
		var goalTitleHighlightCookie = Cookies.get('pcexGoalTitleHighlight');
		if (!goalTitleHighlightCookie) {
			Cookies.set('pcexGoalTitleHighlight', 'shown', { expires: 7 });
			$('#goal_column').css('z-index', '99999');
			$('#overlay').fadeIn(300);
		}
	},

	trackUserActivity: function () {
		if (pcex.userCredentials) {
			var trackingData = {
				user_id: pcex.userCredentials.user,
				group_id: pcex.userCredentials.group,
				session_id: pcex.userCredentials.sessionId,
				activity_set_name: pcex.currentGoal.activityName,
				activity_type: pcex.activityType,
				goal_name: pcex.currentGoal.fileName
			}

			pcex.reportToPcexServer("/track/activity", trackingData,
				function (data) {
					//called when successful
					if (!data.error) {
						pcex.pcexTrackingID = data.result[0].tracking_id;
					} else {
						pcex.pcexTrackingID = null;
					}
				},
				function (error) {
					pcex.pcexTrackingID = null;
				}
			);
		}
	},

	trackCheckResult: function (resultType, result, numberOfTrials, correctLineNumbers, incorrectLineNumbers, wrongAnswers) {
		if (pcex.pcexTrackingID) {
			var trackingData = {
				tracking_id: pcex.pcexTrackingID,
				result_type: resultType,
				correct_line_numbers: correctLineNumbers.toString(),
				incorrect_line_numbers: incorrectLineNumbers.toString(),
				wrong_answers: wrongAnswers.toString(),
				attempt_count: numberOfTrials,
				result: result
			}

			pcex.reportToPcexServer("/track/result", trackingData);
		}
	},

	trackExplanation: function (explanationType, explanationLevel, lineNumber) {
		if (pcex.pcexTrackingID) {
			var trackingData = {
				tracking_id: pcex.pcexTrackingID,
				explanation_type: explanationType,
				explanation_level: explanationLevel,
				line_number: lineNumber
			}

			pcex.reportToPcexServer("/track/explanation", trackingData);
		}
	},

	trackHint: function (hintType, lineNumber) {
		if (pcex.pcexTrackingID) {
			var trackingData = {
				tracking_id: pcex.pcexTrackingID,
				hint_type: hintType,
				line_number: lineNumber
			}

			pcex.reportToPcexServer("/track/hint", trackingData);
		}
	},

	reportToPcexServer: function (apiPath, trackingData, successFunc, errorFunc) {
		$.ajax({
			url: "http://pawscomp2.sis.pitt.edu/pcex/api" + apiPath,
			type: "POST",
			dataType: "json", // expected format for response
			contentType: "application/json; charset=utf-8", // send as JSON
			data: JSON.stringify({ trackingData }),
			success: successFunc,
			error: errorFunc
		});
	},

	reportCheckResultToUm: function (correct) {
		var result = -1;

		if (correct) {
			result = 1;
		} else {
			result = 0;
		}

		// var sub = pcex.getCurrentGoalFileNameWithoutExtensions();

		var umParams = "app=" + pcex.umApplicationId +
			"&act=PCEX_Challenge" +
			"&sub=" + cleanName(pcex.currentGoal.name) + // sub +
			"&res=" + result;

		pcex.reportToUM(umParams);
	},

	reportLineClicksToUm: function (lineNumber) {
		if (pcex.currentGoal.fullyWorkedOut) {
			// var exampleFileName = pcex.getCurrentGoalFileNameWithoutExtensions();

			var umParams = "app=" + pcex.umApplicationId +
				"&act=" + cleanName(pcex.currentGoal.name) + // exampleFileName +
				"&sub=" + lineNumber +
				"&res=-1";

			pcex.reportToUM(umParams);
		}
	},

	reportToUM: function (umParams) {
		if (pcex.userCredentials) {
			umParams += "&usr=" + pcex.userCredentials.user +
				"&grp=" + pcex.userCredentials.group +
				"&sid=" + pcex.userCredentials.sessionId +
				"&svc=" + pcex.userCredentials.svc;

			$.ajax({
				url: 'http://pawscomp2.sis.pitt.edu/cbum/um?' + umParams,
				type: "GET",
				complete: function () {
					//called when complete
				},

				success: function () {
					//console.log('reported to um');
				},

				error: function () {
					//console.log('um report error');
				},
			});

			//pcex.reportToUMThroughPCEX(umParams);
		}
	},

	getCurrentGoalFileNameWithoutExtensions: function () {
		return pcex.currentGoal.fileName.replace(".java", "").replace(".py", "");
	},

	reportToUMThroughPCEX: function (umParams) {
		$.ajax({
			url: 'http://pawscomp2.sis.pitt.edu/pcex/api/reportUM/' + umParams,
			type: "GET",
			complete: function () {
				//called when complete
			},

			success: function () {
				//console.log('reported to um');
			},

			error: function () {
				//console.log('um report error');
			},
		});
	},
}
